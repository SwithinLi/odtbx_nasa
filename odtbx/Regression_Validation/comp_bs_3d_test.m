function fail = comp_bs_3d_test
% Validation test of pointing references 5 and 6 in COMP_BS_3D.m
%
% (This file is part of ODTBX, The Orbit Determination Toolbox, and is
%  distributed under the NASA Open Source Agreement.  See file source for
%  more details.)

% ODTBX: Orbit Determination Toolbox
% 
% Copyright (c) 2003-2011 United States Government as represented by the
% administrator of the National Aeronautics and Space Administration. All
% Other Rights Reserved.
% 
% This file is distributed "as is", without any warranty, as part of the
% ODTBX. ODTBX is free software; you can redistribute it and/or modify it
% under the terms of the NASA Open Source Agreement, version 1.3 or later.
% 
% You should have received a copy of the NASA Open Source Agreement along
% with this program (in a file named License.txt); if not, write to the 
% NASA Goddard Space Flight Center at opensource@gsfc.nasa.gov.

% S. Hur-Diaz
% Emergent Space Technologies
% 02/07/2011

%  REVISION HISTORY
%   Author      		    Date         	Comment
%   Sun Hur-Diaz            02/07/2011      Created
%   Ravi Mathur             08/27/2012      Rename to conform to new
%                                           regression test format

fail = 0;
tol = 1e-10;

epoch = datenum('Feb 7 2011') ;
MU = JATConstant('muEarth')*1e-9;
% Set up orbit
KOE.sma = 7000;
KOE.ecc = .1;
KOE.incl = 0;
KOE.raan = 0;
KOE.argp = 0;
KOE.tran = 0;

n = sqrt(MU/KOE.sma^3);
Tp = 2*pi/n;


t = 0:Tp/7:Tp;

KOEf = kepprop2b(KOE,t,MU);
x = kep2cart(KOEf);

eci2ecef  = jatDCM('eci2ecef', (t/86400)+epoch);
w           = [0;0;JATConstant('wEarth')];

nt = length(t);
rot2ecef = rotransf(repmat(w,[1,nt]),eci2ecef); % Removes omega cross term

sat_pos = zeros(3,nt);
sat_vel = zeros(3,nt);
for n=1:nt
    xf             = rot2ecef(1:6,1:6,n) * x(:,n); %km
    sat_pos(1:3,n) = xf(1:3);
    sat_vel(1:3,n) = xf(4:6);
end

% Check ECEF
ab_f = comp_bs_3d(4,t,sat_pos,sat_vel,[5 -5 6 -6],1);

% Check ECI
ab_i = comp_bs_3d(4,t,x(1:3,:),x(4:6,:),[5 -5 6 -6],0);

% Data

ab_ecef(:,1:4,1) =[
   0.686762303485533   0.981656222814155   0.498807256121241  -0.202548742996933
  -0.726882066439422   0.190657043877541   0.866712339440796   0.979272098832400
  -0.000000019376119  -0.000975617815807  -0.001020735940508  -0.000403929137271];
ab_ecef(:,5:8,1) =[
  -0.773958444373613  -0.999181300094244  -0.623802782977169   0.325937541878053
   0.633236261750534  -0.040443634929811  -0.781581176942042  -0.945391304590058
   0.000403964089961   0.001020752487638   0.000975602292216  -0.000000017989346];
ab_ecef(:,1:4,2) =[
  -0.686762303485533  -0.981656222814155  -0.498807256121241   0.202548742996933
   0.726882066439422  -0.190657043877541  -0.866712339440796  -0.979272098832400
   0.000000019376119   0.000975617815807   0.001020735940508   0.000403929137271];
ab_ecef(:,5:8,2) =[
   0.773958444373613   0.999181300094244   0.623802782977169  -0.325937541878053
  -0.633236261750534   0.040443634929811   0.781581176942042   0.945391304590058
  -0.000403964089961  -0.001020752487638  -0.000975602292216   0.000000017989346];
ab_ecef(:,1:4,3) =[  
   0.000810076695976   0.000855025083241   0.000896822365920   0.000935314498314
   0.000765338405370   0.000714773047806   0.000661573369825   0.000605935432129
   0.999999379016243   0.999999379015606   0.999999379014967   0.999999379014328];
ab_ecef(:,5:8,3) =[
   0.000970359614084   0.001001828551910   0.001029605329623   0.001053587572164
   0.000548064283835   0.000488173202768   0.000426482912110   0.000363220766282
   0.999999379013687   0.999999379013046   0.999999379012403   0.999999379011759];
ab_ecef(:,1:4,4) =[
  -0.000810076695976  -0.000855025083241  -0.000896822365920  -0.000935314498314
  -0.000765338405370  -0.000714773047806  -0.000661573369825  -0.000605935432129
  -0.999999379016243  -0.999999379015606  -0.999999379014967  -0.999999379014328];
ab_ecef(:,5:8,4) =[
  -0.000970359614084  -0.001001828551910  -0.001029605329623  -0.001053587572164
  -0.000548064283835  -0.000488173202768  -0.000426482912110  -0.000363220766282
  -0.999999379013687  -0.999999379013046  -0.999999379012403  -0.999999379011759];


ab_eci(:,1:4,1) =[
                   0  -0.875427786434827  -0.915927597750994  -0.362466804108633
   1.000000000000000   0.483348932695438  -0.401343538228902  -0.931996682354221
                   0                   0                   0                   0];
ab_eci(:,5:8,1) =[
    0.362466804108632   0.915927597750994   0.875427786434827                   0
  -0.931996682354221  -0.401343538228902   0.483348932695438   1.000000000000000
                   0                   0                   0                   0];
ab_eci(:,1:4,2) =[
                   0   0.875427786434827   0.915927597750994   0.362466804108633
  -1.000000000000000  -0.483348932695438   0.401343538228902   0.931996682354221
                   0                   0                   0                   0];
ab_eci(:,5:8,2) =[
  -0.362466804108632  -0.915927597750994  -0.875427786434827                   0
   0.931996682354221   0.401343538228902  -0.483348932695438  -1.000000000000000
                   0                   0                   0                   0];
ab_eci(:,1:4,3) =[
                   0                   0                   0                   0
                   0                   0                   0                   0
   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];
ab_eci(:,5:8,3) =[
                   0                   0                   0                   0
                   0                   0                   0                   0
   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];
ab_eci(:,1:4,4) =[
                   0                   0                   0                   0
                   0                   0                   0                   0
  -1.000000000000000  -1.000000000000000  -1.000000000000000  -1.000000000000000];
ab_eci(:,5:8,4) =[
                   0                   0                   0                   0
                   0                   0                   0                   0
  -1.000000000000000  -1.000000000000000  -1.000000000000000  -1.000000000000000];

err1 = max(max(max(abs(ab_f-ab_ecef))));
err2 = max(max(max(abs(ab_i-ab_eci))));

if err1 > tol || err2 > tol
    fail = 1;
end


